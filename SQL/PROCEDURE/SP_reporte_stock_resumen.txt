--DESCRIPCION
--===========
--PROCEDIMIENTO QUE PERMITE OBTENER EL STOCK EN RESUMEN POR CLIENTE,VARIEDAD,ENVASE,PESO,CATEGORIA,CALIBRE,CAJAS,PALLETS
--PERMITE ELEGIR LA POSICION DE LA PALETA:
--*@POSICION =0 -> PALETAS EN PALETIZADO,TUNEL,CAMARA
--*@POSICION =1 -> PALETAS EN PALETIZADO
--*@POSICION =2 -> PALETAS EN TUNEL
--*@POSICION =3 -> PALETAS EN CAMARA
--PERMITE ELEGIR EL ESTADO DE LA PALETA:
--*@ESTADO =0 -> PALETAS COMPLETAS E INCOMPLETAS
--*@ESTADO =1 -> PALETAS COMPLETAS
--*@ESTADO =2 -> PALETAS INCOMPLETAS
--EL PARAMETRO DEVUELTO EN @RPTA ES 1 CUANDO NO EXISTE ERROR
ALTER PROCEDURE SP_reporte_stock_resumen
(
	@POSICION INT,
	@ESTADO INT
)
AS     
BEGIN
	IF (@POSICION=0) --REPORTE STOCK TOTAL POR CLIENTE,VARIEDAD,ENVASE,PESO,CATEGORIA,CALIBRE,CAJAS,PALLETS
	BEGIN
		IF (@ESTADO=0)--REPORTE STOCK PALETAS ESTADO COMPLETO E INCOMPLETO     
		BEGIN
			SELECT C.NOMBRE AS CLIENTE,V.NOMBRE AS VARIEDAD,E.NOMBRE AS ENVASE,E.PESO AS PESO,CAT.NOMBRE AS CATEGORIA,
			CAL.NOMBRE AS CALIBRE,COUNT(PT.ID_PRODUCTO_TERMINADO)AS CAJAS, CAST(COUNT(PT.ID_PRODUCTO_TERMINADO)AS DECIMAL (18,4))/E.CANT_CAJAS_PALETA  AS PALETAS from PALETA P 
			JOIN DET_PALETA DP ON P.ID_PALETA=DP.ID_PALETA AND DP.ESTADO=1
			JOIN CLIENTE C ON P.ID_CLIENTE=C.ID_CLIENTE
			JOIN PRODUCTO_TERMINADO PT ON DP.ID_PRODUCTO_TERMINADO=PT.ID_PRODUCTO_TERMINADO 
			JOIN LOTE L ON PT.ID_LOTE=L.ID_LOTE
			JOIN CALIBRE CAL ON PT.ID_CALIBRE=CAL.ID_CALIBRE
			JOIN ENVASE E ON PT.ID_ENVASE=E.ID_ENVASE
			JOIN CATEGORIA CAT ON PT.ID_CATEGORIA=CAT.ID_CATEGORIA    
			JOIN VARIEDAD V ON L.ID_VARIEDAD=V.ID_VARIEDAD
			where (P.ESTADO_PALETA=1 OR P.ESTADO_PALETA=2) and (P.POSICION_PALETA=2 or P.POSICION_PALETA=3 or P.POSICION_PALETA=1)
			GROUP BY C.NOMBRE,V.NOMBRE,E.NOMBRE,E.PESO,CAT.NOMBRE,CAL.NOMBRE,E.CANT_CAJAS_PALETA
		END
		IF (@ESTADO=1)--REPORTE STOCK PALETAS ESTADO COMPLETO 
		BEGIN
			SELECT C.NOMBRE AS CLIENTE,V.NOMBRE AS VARIEDAD,E.NOMBRE AS ENVASE,E.PESO AS PESO,CAT.NOMBRE AS CATEGORIA,
			CAL.NOMBRE AS CALIBRE,COUNT(PT.ID_PRODUCTO_TERMINADO)AS CAJAS, CAST(COUNT(PT.ID_PRODUCTO_TERMINADO)AS DECIMAL (18,4))/E.CANT_CAJAS_PALETA  AS PALETAS from PALETA P 
			JOIN DET_PALETA DP ON P.ID_PALETA=DP.ID_PALETA AND DP.ESTADO=1
			JOIN CLIENTE C ON P.ID_CLIENTE=C.ID_CLIENTE
			JOIN PRODUCTO_TERMINADO PT ON DP.ID_PRODUCTO_TERMINADO=PT.ID_PRODUCTO_TERMINADO 
			JOIN LOTE L ON PT.ID_LOTE=L.ID_LOTE
			JOIN CALIBRE CAL ON PT.ID_CALIBRE=CAL.ID_CALIBRE
			JOIN ENVASE E ON PT.ID_ENVASE=E.ID_ENVASE
			JOIN CATEGORIA CAT ON PT.ID_CATEGORIA=CAT.ID_CATEGORIA    
			JOIN VARIEDAD V ON L.ID_VARIEDAD=V.ID_VARIEDAD
			where P.ESTADO_PALETA=1 and (P.POSICION_PALETA=2 or P.POSICION_PALETA=3 or P.POSICION_PALETA=1)
			GROUP BY C.NOMBRE,V.NOMBRE,E.NOMBRE,E.PESO,CAT.NOMBRE,CAL.NOMBRE,E.CANT_CAJAS_PALETA
		END
		IF (@ESTADO=2)--REPORTE STOCK PALETAS ESTADO INCOMPLETO 
		BEGIN
			SELECT C.NOMBRE AS CLIENTE,V.NOMBRE AS VARIEDAD,E.NOMBRE AS ENVASE,E.PESO AS PESO,CAT.NOMBRE AS CATEGORIA,
			CAL.NOMBRE AS CALIBRE,COUNT(PT.ID_PRODUCTO_TERMINADO)AS CAJAS, CAST(COUNT(PT.ID_PRODUCTO_TERMINADO)AS DECIMAL (18,4))/E.CANT_CAJAS_PALETA  AS PALETAS from PALETA P 
			JOIN DET_PALETA DP ON P.ID_PALETA=DP.ID_PALETA AND DP.ESTADO=1
			JOIN CLIENTE C ON P.ID_CLIENTE=C.ID_CLIENTE
			JOIN PRODUCTO_TERMINADO PT ON DP.ID_PRODUCTO_TERMINADO=PT.ID_PRODUCTO_TERMINADO 
			JOIN LOTE L ON PT.ID_LOTE=L.ID_LOTE
			JOIN CALIBRE CAL ON PT.ID_CALIBRE=CAL.ID_CALIBRE
			JOIN ENVASE E ON PT.ID_ENVASE=E.ID_ENVASE
			JOIN CATEGORIA CAT ON PT.ID_CATEGORIA=CAT.ID_CATEGORIA    
			JOIN VARIEDAD V ON L.ID_VARIEDAD=V.ID_VARIEDAD
			where P.ESTADO_PALETA=2 and (P.POSICION_PALETA=2 or P.POSICION_PALETA=3 or P.POSICION_PALETA=1)
			GROUP BY C.NOMBRE,V.NOMBRE,E.NOMBRE,E.PESO,CAT.NOMBRE,CAL.NOMBRE,E.CANT_CAJAS_PALETA
		END
	END
	IF (@POSICION=1)--REPORTE STOCK EN PALETIZADO POR CLIENTE,VARIEDAD,ENVASE,PESO,CATEGORIA,CALIBRE,CAJAS,PALLETS
	BEGIN     
		IF (@ESTADO=0)--REPORTE STOCK PALETAS ESTADO COMPLETO E INCOMPLETO     
		BEGIN
			SELECT C.NOMBRE AS CLIENTE,V.NOMBRE AS VARIEDAD,E.NOMBRE AS ENVASE,E.PESO AS PESO,CAT.NOMBRE AS CATEGORIA,
			CAL.NOMBRE AS CALIBRE,COUNT(PT.ID_PRODUCTO_TERMINADO)AS CAJAS, CAST(COUNT(PT.ID_PRODUCTO_TERMINADO)AS DECIMAL (18,4))/E.CANT_CAJAS_PALETA  AS PALETAS from PALETA P 
			JOIN DET_PALETA DP ON P.ID_PALETA=DP.ID_PALETA AND DP.ESTADO=1
			JOIN CLIENTE C ON P.ID_CLIENTE=C.ID_CLIENTE
			JOIN PRODUCTO_TERMINADO PT ON DP.ID_PRODUCTO_TERMINADO=PT.ID_PRODUCTO_TERMINADO 
			JOIN LOTE L ON PT.ID_LOTE=L.ID_LOTE
			JOIN CALIBRE CAL ON PT.ID_CALIBRE=CAL.ID_CALIBRE
			JOIN ENVASE E ON PT.ID_ENVASE=E.ID_ENVASE
			JOIN CATEGORIA CAT ON PT.ID_CATEGORIA=CAT.ID_CATEGORIA    
			JOIN VARIEDAD V ON L.ID_VARIEDAD=V.ID_VARIEDAD
			where (P.ESTADO_PALETA=1 OR P.ESTADO_PALETA=2) and  P.POSICION_PALETA=1
			GROUP BY C.NOMBRE,V.NOMBRE,E.NOMBRE,E.PESO,CAT.NOMBRE,CAL.NOMBRE,E.CANT_CAJAS_PALETA
		END
		IF (@ESTADO=1)--REPORTE STOCK PALETAS ESTADO COMPLETO 
		BEGIN
			SELECT C.NOMBRE AS CLIENTE,V.NOMBRE AS VARIEDAD,E.NOMBRE AS ENVASE,E.PESO AS PESO,CAT.NOMBRE AS CATEGORIA,
			CAL.NOMBRE AS CALIBRE,COUNT(PT.ID_PRODUCTO_TERMINADO)AS CAJAS, CAST(COUNT(PT.ID_PRODUCTO_TERMINADO)AS DECIMAL (18,4))/E.CANT_CAJAS_PALETA  AS PALETAS from PALETA P 
			JOIN DET_PALETA DP ON P.ID_PALETA=DP.ID_PALETA AND DP.ESTADO=1
			JOIN CLIENTE C ON P.ID_CLIENTE=C.ID_CLIENTE
			JOIN PRODUCTO_TERMINADO PT ON DP.ID_PRODUCTO_TERMINADO=PT.ID_PRODUCTO_TERMINADO 
			JOIN LOTE L ON PT.ID_LOTE=L.ID_LOTE
			JOIN CALIBRE CAL ON PT.ID_CALIBRE=CAL.ID_CALIBRE
			JOIN ENVASE E ON PT.ID_ENVASE=E.ID_ENVASE
			JOIN CATEGORIA CAT ON PT.ID_CATEGORIA=CAT.ID_CATEGORIA    
			JOIN VARIEDAD V ON L.ID_VARIEDAD=V.ID_VARIEDAD
			where P.ESTADO_PALETA=1 and P.POSICION_PALETA=1
			GROUP BY C.NOMBRE,V.NOMBRE,E.NOMBRE,E.PESO,CAT.NOMBRE,CAL.NOMBRE,E.CANT_CAJAS_PALETA
		END
		IF (@ESTADO=2)--REPORTE STOCK PALETAS ESTADO INCOMPLETO 
		BEGIN
			SELECT C.NOMBRE AS CLIENTE,V.NOMBRE AS VARIEDAD,E.NOMBRE AS ENVASE,E.PESO AS PESO,CAT.NOMBRE AS CATEGORIA,
			CAL.NOMBRE AS CALIBRE,COUNT(PT.ID_PRODUCTO_TERMINADO)AS CAJAS, CAST(COUNT(PT.ID_PRODUCTO_TERMINADO)AS DECIMAL (18,4))/E.CANT_CAJAS_PALETA  AS PALETAS from PALETA P 
			JOIN DET_PALETA DP ON P.ID_PALETA=DP.ID_PALETA AND DP.ESTADO=1
			JOIN CLIENTE C ON P.ID_CLIENTE=C.ID_CLIENTE
			JOIN PRODUCTO_TERMINADO PT ON DP.ID_PRODUCTO_TERMINADO=PT.ID_PRODUCTO_TERMINADO 
			JOIN LOTE L ON PT.ID_LOTE=L.ID_LOTE
			JOIN CALIBRE CAL ON PT.ID_CALIBRE=CAL.ID_CALIBRE
			JOIN ENVASE E ON PT.ID_ENVASE=E.ID_ENVASE
			JOIN CATEGORIA CAT ON PT.ID_CATEGORIA=CAT.ID_CATEGORIA    
			JOIN VARIEDAD V ON L.ID_VARIEDAD=V.ID_VARIEDAD
			where P.ESTADO_PALETA=2 and P.POSICION_PALETA=1
			GROUP BY C.NOMBRE,V.NOMBRE,E.NOMBRE,E.PESO,CAT.NOMBRE,CAL.NOMBRE,E.CANT_CAJAS_PALETA
		END
	END
	IF (@POSICION=2)--REPORTE STOCK EN TUNEL POR CLIENTE,VARIEDAD,ENVASE,PESO,CATEGORIA,CALIBRE,CAJAS,PALLETS
	BEGIN     
		IF (@ESTADO=0)--REPORTE STOCK PALETAS ESTADO COMPLETO E INCOMPLETO     
		BEGIN
			SELECT C.NOMBRE AS CLIENTE,V.NOMBRE AS VARIEDAD,E.NOMBRE AS ENVASE,E.PESO AS PESO,CAT.NOMBRE AS CATEGORIA,
			CAL.NOMBRE AS CALIBRE,COUNT(PT.ID_PRODUCTO_TERMINADO)AS CAJAS, CAST(COUNT(PT.ID_PRODUCTO_TERMINADO)AS DECIMAL (18,4))/E.CANT_CAJAS_PALETA  AS PALETAS from PALETA P 
			JOIN DET_PALETA DP ON P.ID_PALETA=DP.ID_PALETA AND DP.ESTADO=1
			JOIN CLIENTE C ON P.ID_CLIENTE=C.ID_CLIENTE
			JOIN PRODUCTO_TERMINADO PT ON DP.ID_PRODUCTO_TERMINADO=PT.ID_PRODUCTO_TERMINADO 
			JOIN LOTE L ON PT.ID_LOTE=L.ID_LOTE
			JOIN CALIBRE CAL ON PT.ID_CALIBRE=CAL.ID_CALIBRE
			JOIN ENVASE E ON PT.ID_ENVASE=E.ID_ENVASE
			JOIN CATEGORIA CAT ON PT.ID_CATEGORIA=CAT.ID_CATEGORIA    
			JOIN VARIEDAD V ON L.ID_VARIEDAD=V.ID_VARIEDAD
			where (P.ESTADO_PALETA=1 OR P.ESTADO_PALETA=2) and  P.POSICION_PALETA=2
			GROUP BY C.NOMBRE,V.NOMBRE,E.NOMBRE,E.PESO,CAT.NOMBRE,CAL.NOMBRE,E.CANT_CAJAS_PALETA
		END
		IF (@ESTADO=1)--REPORTE STOCK PALETAS ESTADO COMPLETO 
		BEGIN
			SELECT C.NOMBRE AS CLIENTE,V.NOMBRE AS VARIEDAD,E.NOMBRE AS ENVASE,E.PESO AS PESO,CAT.NOMBRE AS CATEGORIA,
			CAL.NOMBRE AS CALIBRE,COUNT(PT.ID_PRODUCTO_TERMINADO)AS CAJAS, CAST(COUNT(PT.ID_PRODUCTO_TERMINADO)AS DECIMAL (18,4))/E.CANT_CAJAS_PALETA  AS PALETAS from PALETA P 
			JOIN DET_PALETA DP ON P.ID_PALETA=DP.ID_PALETA AND DP.ESTADO=1
			JOIN CLIENTE C ON P.ID_CLIENTE=C.ID_CLIENTE
			JOIN PRODUCTO_TERMINADO PT ON DP.ID_PRODUCTO_TERMINADO=PT.ID_PRODUCTO_TERMINADO 
			JOIN LOTE L ON PT.ID_LOTE=L.ID_LOTE
			JOIN CALIBRE CAL ON PT.ID_CALIBRE=CAL.ID_CALIBRE
			JOIN ENVASE E ON PT.ID_ENVASE=E.ID_ENVASE
			JOIN CATEGORIA CAT ON PT.ID_CATEGORIA=CAT.ID_CATEGORIA    
			JOIN VARIEDAD V ON L.ID_VARIEDAD=V.ID_VARIEDAD
			where P.ESTADO_PALETA=1 and P.POSICION_PALETA=2
			GROUP BY C.NOMBRE,V.NOMBRE,E.NOMBRE,E.PESO,CAT.NOMBRE,CAL.NOMBRE,E.CANT_CAJAS_PALETA
		END
		IF (@ESTADO=2)--REPORTE STOCK PALETAS ESTADO INCOMPLETO 
		BEGIN
			SELECT C.NOMBRE AS CLIENTE,V.NOMBRE AS VARIEDAD,E.NOMBRE AS ENVASE,E.PESO AS PESO,CAT.NOMBRE AS CATEGORIA,
			CAL.NOMBRE AS CALIBRE,COUNT(PT.ID_PRODUCTO_TERMINADO)AS CAJAS, CAST(COUNT(PT.ID_PRODUCTO_TERMINADO)AS DECIMAL (18,4))/E.CANT_CAJAS_PALETA  AS PALETAS from PALETA P 
			JOIN DET_PALETA DP ON P.ID_PALETA=DP.ID_PALETA AND DP.ESTADO=1
			JOIN CLIENTE C ON P.ID_CLIENTE=C.ID_CLIENTE
			JOIN PRODUCTO_TERMINADO PT ON DP.ID_PRODUCTO_TERMINADO=PT.ID_PRODUCTO_TERMINADO 
			JOIN LOTE L ON PT.ID_LOTE=L.ID_LOTE
			JOIN CALIBRE CAL ON PT.ID_CALIBRE=CAL.ID_CALIBRE
			JOIN ENVASE E ON PT.ID_ENVASE=E.ID_ENVASE
			JOIN CATEGORIA CAT ON PT.ID_CATEGORIA=CAT.ID_CATEGORIA    
			JOIN VARIEDAD V ON L.ID_VARIEDAD=V.ID_VARIEDAD
			where P.ESTADO_PALETA=2 and P.POSICION_PALETA=2
			GROUP BY C.NOMBRE,V.NOMBRE,E.NOMBRE,E.PESO,CAT.NOMBRE,CAL.NOMBRE,E.CANT_CAJAS_PALETA
		END
	END
	IF (@POSICION=3)--REPORTE STOCK EN CAMARA POR CLIENTE,VARIEDAD,ENVASE,PESO,CATEGORIA,CALIBRE,CAJAS,PALLETS
	BEGIN     
		IF (@ESTADO=0)--REPORTE STOCK PALETAS ESTADO COMPLETO E INCOMPLETO     
		BEGIN
			SELECT C.NOMBRE AS CLIENTE,V.NOMBRE AS VARIEDAD,E.NOMBRE AS ENVASE,E.PESO AS PESO,CAT.NOMBRE AS CATEGORIA,
			CAL.NOMBRE AS CALIBRE,COUNT(PT.ID_PRODUCTO_TERMINADO)AS CAJAS, CAST(COUNT(PT.ID_PRODUCTO_TERMINADO)AS DECIMAL (18,4))/E.CANT_CAJAS_PALETA  AS PALETAS from PALETA P 
			JOIN DET_PALETA DP ON P.ID_PALETA=DP.ID_PALETA AND DP.ESTADO=1
			JOIN CLIENTE C ON P.ID_CLIENTE=C.ID_CLIENTE
			JOIN PRODUCTO_TERMINADO PT ON DP.ID_PRODUCTO_TERMINADO=PT.ID_PRODUCTO_TERMINADO 
			JOIN LOTE L ON PT.ID_LOTE=L.ID_LOTE
			JOIN CALIBRE CAL ON PT.ID_CALIBRE=CAL.ID_CALIBRE
			JOIN ENVASE E ON PT.ID_ENVASE=E.ID_ENVASE
			JOIN CATEGORIA CAT ON PT.ID_CATEGORIA=CAT.ID_CATEGORIA    
			JOIN VARIEDAD V ON L.ID_VARIEDAD=V.ID_VARIEDAD
			where (P.ESTADO_PALETA=1 OR P.ESTADO_PALETA=2) and  P.POSICION_PALETA=3
			GROUP BY C.NOMBRE,V.NOMBRE,E.NOMBRE,E.PESO,CAT.NOMBRE,CAL.NOMBRE,E.CANT_CAJAS_PALETA
		END
		IF (@ESTADO=1)--REPORTE STOCK PALETAS ESTADO COMPLETO 
		BEGIN
			SELECT C.NOMBRE AS CLIENTE,V.NOMBRE AS VARIEDAD,E.NOMBRE AS ENVASE,E.PESO AS PESO,CAT.NOMBRE AS CATEGORIA,
			CAL.NOMBRE AS CALIBRE,COUNT(PT.ID_PRODUCTO_TERMINADO)AS CAJAS, CAST(COUNT(PT.ID_PRODUCTO_TERMINADO)AS DECIMAL (18,4))/E.CANT_CAJAS_PALETA  AS PALETAS from PALETA P 
			JOIN DET_PALETA DP ON P.ID_PALETA=DP.ID_PALETA AND DP.ESTADO=1
			JOIN CLIENTE C ON P.ID_CLIENTE=C.ID_CLIENTE
			JOIN PRODUCTO_TERMINADO PT ON DP.ID_PRODUCTO_TERMINADO=PT.ID_PRODUCTO_TERMINADO 
			JOIN LOTE L ON PT.ID_LOTE=L.ID_LOTE
			JOIN CALIBRE CAL ON PT.ID_CALIBRE=CAL.ID_CALIBRE
			JOIN ENVASE E ON PT.ID_ENVASE=E.ID_ENVASE
			JOIN CATEGORIA CAT ON PT.ID_CATEGORIA=CAT.ID_CATEGORIA    
			JOIN VARIEDAD V ON L.ID_VARIEDAD=V.ID_VARIEDAD
			where P.ESTADO_PALETA=1 and P.POSICION_PALETA=3
			GROUP BY C.NOMBRE,V.NOMBRE,E.NOMBRE,E.PESO,CAT.NOMBRE,CAL.NOMBRE,E.CANT_CAJAS_PALETA
		END
		IF (@ESTADO=2)--REPORTE STOCK PALETAS ESTADO INCOMPLETO 
		BEGIN
			SELECT C.NOMBRE AS CLIENTE,V.NOMBRE AS VARIEDAD,E.NOMBRE AS ENVASE,E.PESO AS PESO,CAT.NOMBRE AS CATEGORIA,
			CAL.NOMBRE AS CALIBRE,COUNT(PT.ID_PRODUCTO_TERMINADO)AS CAJAS, CAST(COUNT(PT.ID_PRODUCTO_TERMINADO)AS DECIMAL (18,4))/E.CANT_CAJAS_PALETA  AS PALETAS from PALETA P 
			JOIN DET_PALETA DP ON P.ID_PALETA=DP.ID_PALETA AND DP.ESTADO=1
			JOIN CLIENTE C ON P.ID_CLIENTE=C.ID_CLIENTE
			JOIN PRODUCTO_TERMINADO PT ON DP.ID_PRODUCTO_TERMINADO=PT.ID_PRODUCTO_TERMINADO 
			JOIN LOTE L ON PT.ID_LOTE=L.ID_LOTE
			JOIN CALIBRE CAL ON PT.ID_CALIBRE=CAL.ID_CALIBRE
			JOIN ENVASE E ON PT.ID_ENVASE=E.ID_ENVASE
			JOIN CATEGORIA CAT ON PT.ID_CATEGORIA=CAT.ID_CATEGORIA    
			JOIN VARIEDAD V ON L.ID_VARIEDAD=V.ID_VARIEDAD
			where P.ESTADO_PALETA=2 and P.POSICION_PALETA=3
			GROUP BY C.NOMBRE,V.NOMBRE,E.NOMBRE,E.PESO,CAT.NOMBRE,CAL.NOMBRE,E.CANT_CAJAS_PALETA
		END
	END

END