CREATE PROCEDURE SP_reporte_cajas_seleccionadas_por_trabajador
(
	@OPERACION INT,
	@FECHA_INICIO VARCHAR(11),
	@FECHA_FIN VARCHAR(11),
	@RPTA INT
)
AS
BEGIN
	DECLARE @ID_RECEPCION INT=0
	IF (@OPERACION=1) --CAJAS SELECCIONADAS POR TRABAJADOR POR RANGO FECHA
	BEGIN
		SELECT E.NOMBRE,E.APELLIDO,EN.NOMBRE,COUNT(PT.SELECCIONADOR) AS CAJAS_SELECCIONADAS FROM PRODUCTO_TERMINADO PT
		JOIN EMPLEADO E ON PT.SELECCIONADOR=E.DNI 
		JOIN ENVASE EN ON PT.ID_ENVASE=EN.ID_ENVASE
		JOIN DIA_RECEPCION D ON PT.ID_DIA_RECEPCION=D.ID_DIA_RECEPCION
		WHERE D.HORA_INICIO>=@FECHA_INICIO AND D.HORA_INICIO<=@FECHA_FIN
		GROUP BY E.NOMBRE,E.APELLIDO,EN.NOMBRE
		ORDER BY COUNT(E.DNI) DESC
	END
	
	IF(@OPERACION=2) --CAJAS SELECCIONADAS EL ULTIMO DIA DE RECEPCION CERRADO
	BEGIN
		SET @ID_RECEPCION= (SELECT TOP 1 ISNULL(ID_DIA_RECEPCION,0) FROM DIA_RECEPCION WHERE ES_CERRADO=1 ORDER BY ID_DIA_RECEPCION DESC)
		SELECT E.NOMBRE,E.APELLIDO,EN.NOMBRE,COUNT(PT.SELECCIONADOR) AS CAJAS_SELECCIONADAS FROM PRODUCTO_TERMINADO PT
		JOIN EMPLEADO E ON PT.SELECCIONADOR=E.DNI 
		JOIN ENVASE EN ON PT.ID_ENVASE=EN.ID_ENVASE
		WHERE PT.ID_DIA_RECEPCION=@ID_RECEPCION
		GROUP BY E.NOMBRE,E.APELLIDO,EN.NOMBRE
		ORDER BY COUNT(E.DNI) DESC
	END
	
	IF(@OPERACION=3) --CAJAS SELECCIONADAS EL ULTIMO DIA DE RECEPCION ABIERTO
	BEGIN
		SET @ID_RECEPCION= (SELECT TOP 1 ISNULL(ID_DIA_RECEPCION,0) FROM DIA_RECEPCION WHERE ES_CERRADO=0 ORDER BY ID_DIA_RECEPCION DESC)
		SELECT E.NOMBRE,E.APELLIDO,EN.NOMBRE,COUNT(PT.SELECCIONADOR) AS CAJAS_SELECCIONADAS FROM PRODUCTO_TERMINADO PT
		JOIN EMPLEADO E ON PT.SELECCIONADOR=E.DNI 
		JOIN ENVASE EN ON PT.ID_ENVASE=EN.ID_ENVASE
		WHERE PT.ID_DIA_RECEPCION=@ID_RECEPCION
		GROUP BY E.NOMBRE,E.APELLIDO,EN.NOMBRE
		ORDER BY COUNT(E.DNI) DESC
	END
END
