--DESCRIPCION
--===========
--TRIGGER QUE ACTUALIZA EL ESTADO DE LA PALETA Y EL ESTADO DE DET_ESTADO_PALETA
--CUANDO LA PALETA SE QUEDA SIN CAJAS ACTIVAS DEBIDO A UNA REPALETIZACION
ALTER TRIGGER [dbo].[TR_actualiza_estado_paleta_a_repaletizada]
ON DET_PALETA
FOR UPDATE
AS
	DECLARE @CONT INT =0
	--OBTENGO EL ID UTILIZANDO LA IDENTIDAD
	DECLARE @ID_DET_PALETA INT=(SELECT ID_DET_PALETA FROM inserted)
	--OBTENGO EL ID DE LA PALETA A LA QUE PERTENECE EL DETALLE
	DECLARE @ID_PALETA INT=(SELECT ID_PALETA FROM DET_PALETA WHERE ID_DET_PALETA=@ID_DET_PALETA) 
	--VERIFICO QUE LA ACTUALIZACION SEA DEBIDO A UN REPALETIZADO
	IF ((SELECT ESTADO FROM DET_PALETA WHERE ID_DET_PALETA=@ID_DET_PALETA)=5) 
	BEGIN
		--OBTENGO EL NUMERO DE CAJAS ACTIVAS
		SET @CONT =(SELECT COUNT(DP.ID_DET_PALETA) FROM PALETA P 
		JOIN DET_PALETA DP ON P.ID_PALETA=DP.ID_PALETA	
		WHERE P.ID_PALETA=@ID_PALETA AND DP.ESTADO=1)
		--VERIFICO SI ESTA VACIA
		IF (@CONT=0)
		BEGIN
			--ACTUALIZO ESTADO DE PALETA
			UPDATE PALETA SET ESTADO_PALETA=5 WHERE ID_PALETA=@ID_PALETA
			--INSERTO ESTADO EN DET_ESTADO_PALETA
			INSERT INTO DET_ESTADO_PALETA (ID_PALETA,ESTADO_NUEVO,FECHA_REGISTRO)VALUES
			(@ID_PALETA,5,GETDATE())
		END
	END
	--VERIFICO QUE LA ACTUALIZACION SEA DEBIDO A UNA BAJA DE FRIO
	IF ((SELECT ESTADO FROM DET_PALETA WHERE ID_DET_PALETA=@ID_DET_PALETA)=3) 
	BEGIN
		--OBTENGO EL NUMERO DE CAJAS ACTIVAS
		SET @CONT =(SELECT COUNT(DP.ID_DET_PALETA) FROM PALETA P 
		JOIN DET_PALETA DP ON P.ID_PALETA=DP.ID_PALETA	
		WHERE P.ID_PALETA=@ID_PALETA AND DP.ESTADO=1)
		--VERIFICO SI ESTA VACIA
		IF (@CONT=0)
		BEGIN
			--ACTUALIZO ESTADO DE PALETA
			UPDATE PALETA SET ESTADO_PALETA=3 WHERE ID_PALETA=@ID_PALETA
			--INSERTO ESTADO EN DET_ESTADO_PALETA
			INSERT INTO DET_ESTADO_PALETA (ID_PALETA,ESTADO_NUEVO,FECHA_REGISTRO)VALUES
			(@ID_PALETA,3,GETDATE())
		END
	END
		--VERIFICO QUE LA ACTUALIZACION SEA DEBIDO A UNA CORTESIA
	IF ((SELECT ESTADO FROM DET_PALETA WHERE ID_DET_PALETA=@ID_DET_PALETA)=4) 
	BEGIN
		--OBTENGO EL NUMERO DE CAJAS ACTIVAS
		SET @CONT =(SELECT COUNT(DP.ID_DET_PALETA) FROM PALETA P 
		JOIN DET_PALETA DP ON P.ID_PALETA=DP.ID_PALETA	
		WHERE P.ID_PALETA=@ID_PALETA AND DP.ESTADO=1)
		--VERIFICO SI ESTA VACIA
		IF (@CONT=0)
		BEGIN
			--ACTUALIZO ESTADO DE PALETA
			UPDATE PALETA SET ESTADO_PALETA=4 WHERE ID_PALETA=@ID_PALETA
			--INSERTO ESTADO EN DET_ESTADO_PALETA
			INSERT INTO DET_ESTADO_PALETA (ID_PALETA,ESTADO_NUEVO,FECHA_REGISTRO)VALUES
			(@ID_PALETA,4,GETDATE())
		END
	END